# https://taskfile.dev
#
# we can't use cookie cutter for these tasks
#   it is necessary for us to rev all the repositories
#   cookiecutter may not be the right choice for that

version: '3'

vars:
  task_version: 3.35.1

tasks:
  mkdir:
    internal: true
    cmds:
      - mkdir -p {{ .USER_WORKING_DIR }}/.github/workflows
  hello_world_action:
    cmds:
      - task: mkdir
        ignore_error: true
      - |
        cat <<EOF > {{ .USER_WORKING_DIR }}/.github/workflows/hello-world-action.yml
        name: hello-world
        on: push
        jobs:
          my-job:
            runs-on: ubuntu-latest
            steps:
              - name: my-step
                run: echo "Hello World!"
        EOF
  # TODO: setup matrix for image builds
  # extract checkout + go task setup + taskfiles download to a reusable template
  ansible_role:
    cmds:
      - task: mkdir
        ignore_error: true
      - |
        cat <<EOF > {{ .USER_WORKING_DIR }}/.github/workflows/ansible_role.yml
        name: ansible_role
        on: push
        jobs:
          ansible-role:
            runs-on: ubuntu-latest
            container:
              image: quay.io/bradfordwagner/ansible:3.6.2-debian_bookworm
            steps:
              - uses: actions/checkout@v4
              - name: Setup go-task
                uses: pnorton5432/setup-task@v1
                with:
                  task-version: {{ .task_version }}
              - name: task version
                run: task --version
              - name: checkout taskfiles
                uses: actions/checkout@v4
                with:
                  path: taskfiles
                  repository: bradfordwagner/taskfiles
              - name: Invoke Ansible Role Test
                run: task -t ./taskfiles/tasks/ansible_role.yml
        EOF
